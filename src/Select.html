<svelte:window on:click="handleWindowClick(event)" on:keydown="handleKeyDown(event)" on:resize="getPosition()"/>

<div class="selectContainer {isDisabled ? 'disabled' : ''}{isFocused ? 'focused' : ''}" on:click="handleClick()"
     ref:container style="{containerStyles}">
    <input on:focus="handleFocus()" ref:input placeholder="{placeholderText}" bind:value="filterText"
           disabled="{isDisabled}" style="{inputStyles}">

    {#if showSelectedItem }
    <div class="selectedItem" on:focus="handleFocus()" ref:selectedItem>
        <svelte:component this="{Selection}" {selectedItem}/>
    </div>
    {#if !isDisabled}
    <div class="clearSelectedItem" on:click="handleClear(event)">
        <svg class="icon svelte-qw6fkp" width="100%" height="100%" viewBox="-2 -2 50 50" focusable="false"
             role="presentation">
            <path fill="currentColor"
                  d="M34.923,37.251L24,26.328L13.077,37.251L9.436,33.61l10.923-10.923L9.436,11.765l3.641-3.641L24,19.047L34.923,8.124 l3.641,3.641L27.641,22.688L38.564,33.61L34.923,37.251z"></path>
        </svg>
    </div>
    {/if}
    {/if}
</div>

<style>
    .selectContainer {
        border: 1px solid #D8DBDF;
        border-radius: 3px;
        height: 44px;
        position: relative;
        padding: 0 16px;
    }

    .selectContainer input {
        border: none;
        color: #3F4F5F;
        height: 44px;
        line-height: 44px;
        padding: 0 16px;
        width: 100%;
        background: transparent;
        font-size: 14px;
        letter-spacing: -0.08px;
        position: absolute;
        left: 0;
    }

    .selectContainer input::placeholder {
        color: #78848F;
    }

    .selectContainer input:focus {
        outline: none;
    }

    .selectContainer:hover {
        border-color: #b2b8bf;
    }

    .selectContainer.focused {
        border-color: #006FE8;
    }

    .selectContainer.disabled {
        background: #F6F7F8;
        border-color: #F6F7F8;
        color: #C1C6CC;
    }

    .selectContainer.disabled input::placeholder {
        color: #C1C6CC;
    }

    .selectedItem {
        /*padding: 0 16px;*/
        line-height: 44px;
    }

    .selectedItem:focus {
        outline: none;
    }

    .clearSelectedItem {
        position: absolute;
        right: 10px;
        top: 12px;
        width: 20px;
        height: 20px;
        color: #c5cacf;
    }

    .clearSelectedItem:hover {
        color: #2c3e50;
    }

    .selectContainer.focused .clearSelectedItem {
        color: #3F4F5F;
    }
</style>

<script>
  import List from './List.html';
  import Item from './Item.html'
  import Selection from './Selection.html'

  export default {
    data() {
      return {
        items: [],
        filterText: '',
        listOpen: false,
        Item,
        Selection,
        paddingLeft: 0,
        list: undefined,
        target: undefined
      }
    },
    computed: {
      showSelectedItem({selectedItem, filterText}) {
        return selectedItem && filterText.length === 0;
      },
      placeholderText({selectedItem}) {
        return selectedItem ? '' : 'Select...'
      },
      filteredItems({items, filterText}) {
        const itemsWithIndex = items.map((item, i) => {
          item.index = i;
          return item;
        });
        return itemsWithIndex.filter(item => {
          if (filterText.length < 1) return true;
          return item.label.toLowerCase().includes(filterText.toLowerCase())
        })
      }
    },
    onstate({changed, current, previous}) {
      if (!previous) return;

      if (changed.listOpen) {
        if (current.listOpen) {
          this.loadList();
        } else {
          this.removeList();
        }
      }

      if (changed.filterText && current.filterText.length === 1) {
        this.loadList();
        this.set({listOpen: true});
      }

      if (changed.isFocused) {
        const {isFocused} = current;
        if (isFocused) {
          this.handleFocus();
        } else {
          this.set({filterText: ''})
        }
      }

      if (changed.filteredItems && current.list) {
        current.list.set({items: current.filteredItems})
      }
    },
    methods: {
      getPosition() {
        const {target} = this.get();
        if (!target) return;
        const {top, height, width} = this.refs.container.getBoundingClientRect();
        target.style.top = `${height + 5}px`;
        target.style.minWidth = `${width}px`;
        target.style.left = '0';
        this.set({target});
      },
      handleKeyDown(e) {
        const {isFocused, listOpen} = this.get();
        if (!isFocused) return;

        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            this.set({listOpen: true});
            break;
          case 'ArrowUp':
            e.preventDefault();
            this.set({listOpen: true});
            break;
          case 'Tab':
            if (!listOpen) this.set({isFocused: false});
            break;
        }
      },
      handleFocus() {
        this.set({isFocused: true});
        if (this.refs.input) this.refs.input.focus();
      },
      removeList() {
        let {list, target} = this.get();
        this.set({filterText: ''});

        if (!list) return;
        list.destroy();
        list = undefined;

        if (!target) return;
        target.remove();
        target = undefined;

        this.set({list, target});
      },
      handleWindowClick(event) {
        if (!this.refs.container) return;
        if (this.refs.container.contains(event.target)) return;
        this.set({isFocused: false, listOpen: false});
        if (this.refs.input) this.refs.input.blur();
      },
      handleClick() {
        const {isDisabled, listOpen} = this.get();
        if (isDisabled) return;
        this.set({isFocused: true, listOpen: !listOpen});
      },
      handleClear(e) {
        e.stopPropagation();
        this.set({selectedItem: undefined, listOpen: false});
        this.handleFocus();
      },
      loadList() {
        let {target, list} = this.get();
        if (target && list) return;
        target = document.createElement('div');

        Object.assign(target.style, {
          position: 'absolute',
          'z-index': 2
        });

        this.set({list, target});

        this.getPosition();
        this.refs.container.appendChild(target);
        list = new List({
          target,
          data: {
            Item: this.get().Item
          }
        });

        const {items, selectedItem, filteredItems} = this.get();

        if (items) {
          const match = JSON.stringify(selectedItem);
          const activeItemIndex = items.findIndex(item => JSON.stringify(item) === match);
          list.set({items: filteredItems, activeItemIndex});
        }

        list.on('itemSelected', (newSelection) => {
          if (newSelection) {
            this.set({
              selectedItem: {...selectedItem, ...newSelection},
              listOpen: false
            });
          }
        });

        this.set({list, target});
      }
    },
    oncreate() {
      const {listOpen} = this.get();
      if (listOpen) this.loadList();
    },
    ondestroy() {
      this.removeList()
    }
  }
</script>
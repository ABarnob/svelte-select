<svelte:window on:click="handleWindowClick(event)" on:keydown="handleKeyDown(event)" on:resize="getPosition()"/>

<div class="selectContainer {isFocused ? 'focused' : ''}" on:click="handleClick()" ref:container>
    <input on:focus="handleFocus()" ref:input placeholder="{placeholderText}" bind:value="filterText">

    {#if showSelectedItem }
    <div class="selectedItem" on:focus="handleFocus()" ref:selectedItem>{selectedItem.name}</div>
    <div class="clearSelectedItem" on:click="handleClear(event)">
        <svg class="icon svelte-qw6fkp" width="100%" height="100%" viewBox="-2 -2 50 50" focusable="false"
             role="presentation">
            <path fill="currentColor"
                  d="M34.923,37.251L24,26.328L13.077,37.251L9.436,33.61l10.923-10.923L9.436,11.765l3.641-3.641L24,19.047L34.923,8.124 l3.641,3.641L27.641,22.688L38.564,33.61L34.923,37.251z"></path>
        </svg>
    </div>
    {/if}
</div>

<style>
    .selectContainer {
        border: 1px solid #D8DBDF;
        border-radius: 3px;
        height: 44px;
        position: relative;
    }

    .selectContainer input {
        border: none;
        color: #3F4F5F;
        height: 44px;
        line-height: 44px;
        padding: 0 16px;
        width: 100%;
        background: transparent;
        font-size: 14px;
        letter-spacing: -0.08px;
        position: absolute;
    }

    .selectContainer input::placeholder {
        color: #78848F;
    }

    .selectContainer input:focus {
        outline: none;
    }

    .selectContainer:hover {
        border-color: #b2b8bf;
    }

    .selectContainer.focused {
        border-color: #006FE8;
    }

    .selectedItem {
        padding: 0 16px;
        line-height: 44px;
    }

    .selectedItem:focus {
        outline: none;
    }

    .clearSelectedItem {
        position: absolute;
        right: 10px;
        top: 12px;
        width: 20px;
        height: 20px;
        color: #c5cacf;
    }

    .clearSelectedItem:hover {
        color: #2c3e50;
    }

    .selectContainer.focused .clearSelectedItem {
        color: #3F4F5F;
    }
</style>

<script>
  import List from './List.html';

  let list;
  let target;

  export default {
    computed: {
      showSelectedItem({selectedItem, filterText}) {
        return selectedItem && filterText.length === 0;
      }
    },
    data() {
      return {
        filterText: '',
        placeholderText: 'Select...'
      }
    },
    onstate({changed, current, previous}) {
      if (!previous) return;


      if (changed.isFocused) {
        const {isFocused} = current;
        if (isFocused && this.refs.input) {
          this.refs.input.focus();
          // this.loadList();
        }
      }
    },
    methods: {
      getPosition() {
        if (!target) return;
        const { top, left, bottom, width } = this.refs.container.getBoundingClientRect();
        target.style.top = `${bottom + 5}px`;
        target.style.left = `${left}px`;
        target.style.minWidth = `${width}px`;
      },
      handleKeyDown(e) {
        const {isFocused} = this.get();
        if (!isFocused) return;

        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            this.loadList();
            break;
          case 'ArrowUp':
            e.preventDefault();
            this.loadList();
            break;
          case 'Tab':
            e.preventDefault();
            this.loadList();
            break;
        }
      },
      handleFocus() {
        this.set({isFocused: true});
      },
      removeList() {
        if (!list) return;
        list.destroy();
        list = undefined;

        if (!target) return;
        target.remove();
        target = undefined;

        if (!this.get().selectedItem) {
          this.set({placeholderText: 'Select...', filterText: ''});
        }
      },
      handleWindowClick(event) {
        if (this.refs.container.contains(event.target)) return;
        this.set({isFocused: false});
        if (this.refs.input) this.refs.input.blur();
        this.removeList();
      },
      handleClick() {
        this.set({isFocused: true});
        this.loadList();
      },
      handleClear(e) {
        e.stopPropagation();
        this.set({selectedItem: undefined, placeholderText: 'Select...'});
        if (this.refs.input) this.refs.input.focus();
        this.removeList();
      },
      loadList() {
        if (target && list) return;

        if (this.refs.selectedItem) this.refs.selectedItem.removeAttribute('tabindex');
        target = document.createElement('div');

        Object.assign(target.style, {
          position: 'absolute',
        });

        this.getPosition();

        document.body.appendChild(target);
        list = new List({
          target
        });

        const {items, selectedItem} = this.get();

        if (items) {
          const match = JSON.stringify(selectedItem);
          const activeItemIndex = items.findIndex(item => JSON.stringify(item) === match);
          list.set({items, activeItemIndex});
        }

        list.on('itemSelected', (selectedItem) => {
          this.set({
            selectedItem,
            placeholderText: ''
          });
          this.removeList();
          if (this.get().showSelectedItem)
            this.refs.selectedItem.setAttribute('tabindex', '0');
        });

        if (this.get().selectedItem) {
          this.set({placeholderText: ''});
        }
      }
    },
    ondestroy() {
      this.removeList()
    }
  }
</script>